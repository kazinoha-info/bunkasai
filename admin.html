<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>管理ページ</title>
</head>
<body>

<h1>文化祭 防災管理</h1>

<button onclick="startDrill()">訓練開始</button>
<button onclick="startReal()">本番警報</button>
<button onclick="stopAll()">解除</button>

<hr>

<h2>混雑更新</h2>

<select id="cName">
  <option value="">選択してください</option>
</select>
<select id="cStatus">
  <option>○</option>
  <option>△</option>
  <option>×</option>
</select>

<button onclick="updateCrowd()">更新</button>


<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>


<script>

const firebaseConfig = {
  apiKey: "AIzaSyDTHN-YfAJz86NgNAaldixubGfDZwRgnKw",
  authDomain: "bunkasai-info-59212.firebaseapp.com",
  databaseURL: "https://bunkasai-info-59212-default-rtdb.firebaseio.com",
  projectId: "bunkasai-info-59212",
  storageBucket: "bunkasai-info-59212.firebasestorage.app",
  messagingSenderId: "775251011941",
  appId: "1:775251011941:web:7237a990162fa00217198c"
};


firebase.initializeApp(firebaseConfig);
const db = firebase.database();

function startDrill(){
  db.ref("system").set({
    emergency:true,
    mode:"drill",
    message:"緊急地震速報訓練中です。これはテストです。いつも通り過ごしてください。"
  });
}

function startReal(){
  db.ref("system").set({
    emergency:true,
    mode:"real",
    message:"強い揺れに警戒してください。身を守ってください。付近に倒れやすいもの落ちてきやすいものなどがある場合は速やかに移動してください。地震が収まり次第、係委員の指示に従ってください。"
  });
}

function stopAll(){
  db.ref("system").set({
    emergency:false,
    mode:"normal"
  });
}

function updateCrowd(){

  const name = document.getElementById("cName").value;
  const status = document.getElementById("cStatus").value;

  if(!name){
    alert("場所を選んでください");
    return;
  }

  db.ref("classes/"+name).update({
    status: status
  });

  alert("更新OK");
}
  // クラス一覧を取得してプルダウンに入れる
db.ref("classes").on("value", snap => {

  const data = snap.val();
  const select = document.getElementById("cName");

  select.innerHTML = '<option value="">選択してください</option>';

  if(!data) return;

  for(let key in data){

    const opt = document.createElement("option");

    opt.value = key;
    opt.textContent = data[key].name;

    select.appendChild(opt);
  }

});

</script>

</body>
</html>
