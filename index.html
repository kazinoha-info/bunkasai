<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>文化祭案内</title>
<style>
/* スタイル設定（ご提示のものをベースに、停車駅の表示崩れのみ修正） */
body{
  margin:0;
  font-family: "Segoe UI", "Noto Sans JP", sans-serif;
  background: linear-gradient(180deg,#f7f9fc,#eaf3ff);
}
#ticker{
  background: linear-gradient(90deg,#ff9800,#ff6f00);
  color:white;
  overflow:hidden;
  white-space:nowrap;
  height:80px;
  line-height:80px;
  box-shadow:0 2px 8px rgba(0,0,0,0.2);
}
#ticker-text{
  display:inline-block;
  min-width:200%;
  padding-left:100%;
  animation: scroll 60s linear infinite;
  font-size:26px;
  font-weight:600;
}
@keyframes scroll{ from{ transform: translateX(0); } to{ transform: translateX(-100%); } }
#layout{ display:grid; grid-template-columns: 3fr 2fr; height: calc(100vh - 100px); }

#left{ overflow:auto; padding:20px; }
#right{
  background:white;
  margin:15px;
  border-radius:15px;
  padding:20px;
  box-shadow:0 4px 12px rgba(0,0,0,0.15);
  overflow-y:auto;
}

/* 混雑表示 */
.crowd-grid{ display:grid; grid-template-columns: repeat(2, 1fr); gap:16px; }
.card{
  background: #005c3c;
  color:white;
  border-radius:12px;
  padding:18px;
  height: 55px;
  box-shadow:0 3px 8px rgba(0,0,0,0.25);
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:55px;
  font-weight:bold;
}
.status{ font-size:40px; font-weight:bold; width:50px; height:50px; border-radius:6px; display:flex; justify-content:center; align-items:center; }
.ok{ background:#2e7d32; color:white; } 
.mid{ background:#f9a825; color:#333; } 
.ng{ background:#c62828; color:white; }

#right h2{ font-size:28px; font-weight:bold; color:white; background:black; padding:8px; border-radius:6px; text-align:center; margin-top:5px; }
.btns{ margin:10px 0; }
.btns button{ background: #eee; color:#333; font-weight:600; border-radius:20px; padding:6px 16px; border:none; cursor:pointer; }
.btns button.active{ background:#ff9800; color:white; }

.jr-board{
  background: linear-gradient(180deg,#050505,#181818);
  color:#00c3ff;
  border-radius:15px;
  padding:18px;
  margin-bottom:18px;
  box-shadow:0 0 12px rgba(0,195,255,0.25);
}
.jr-row{ display:flex; font-size:22px; padding:5px 0; border-bottom:1px solid #333; }
.jr-time{ width:100px; color:white; font-weight:bold; font-size: 20px; }
.jr-dest{ flex:1; color:white; font-size: 20px; }

/* ★ここを修正：停車駅が半分見えない問題を解消★ */
.stops{ 
  margin-top:10px; 
  overflow:hidden; 
  white-space:nowrap; 
  color:white; 
  font-weight:bold; 
  position: relative; 
  height: 40px;      /* 高さを十分に確保 */
  line-height: 40px; /* 文字が上下中央に来るように */
}
.stops span{ 
  display:inline-block; 
  font-size:28px; 
  white-space: nowrap; 
  will-change: transform; 
  position: absolute; 
  top: 0;            /* 上に張り付かないように固定 */
}
.stops.fixed{ 
  overflow: visible; 
  white-space: normal; 
  height: auto;      /* 固定表示は高さ自動 */
  line-height: 1.4; 
  font-size:26px; 
  position: static; 
}

.jr-board h3{ font-size:30px; font-weight:bold; color:white; margin:5px 0 10px; }
.jr-board b{ font-size:24px; font-weight:bold; color:white; }
.bus-columns{ display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
.bus-col b{ display: block; text-align: center; font-size: 22px; margin-bottom: 5px; color: #ffae00; }

#nowTime{
  text-align:center;
  font-size:24px;
  font-weight:bold;
  color:white;
  background:#111;
  padding:8px;
  border-radius:10px;
  margin-bottom:10px;
  letter-spacing:1px;
}
.schedule-card{
  background:#111;
  border-radius:10px;
  padding:8px 10px;
  margin:6px 0;
  display:flex;
  align-items:center;
  box-shadow:0 2px 6px rgba(0,0,0,0.4);
}
.legend{
  grid-column: span 2;
  margin-top:15px;
  font-size:17px;
  color:#333;
  text-align:center;
  font-weight:bold;
}
.traffic-note{ font-size:12px; color:#aaa; text-align:center; margin-top:10px; }
#emergencyScreen{
  position:fixed;
  top:0;left:0;
  width:100%;
  height:100%;
  background:#c62828;
  color:white;
  display:none;
  justify-content:center;
  align-items:center;
  z-index:9999;
}

#emBox{
  text-align:center;
  width:100%;
  max-width:1200px;
}

#emTitle{
  font-size:60px;
}

#emMessage{
  font-size:28px;
  margin:20px 0;
}
/* 緊急動画 16:9 用 */
.video-box{
  position: relative;
  width: 100%;
  max-width: 1600px;
  margin: 20px auto;
  padding-top: 56.25%; /* 16:9 */
}

.video-box iframe{
  position: absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  border:0;
}
</style>
</head>
<body>

<div id="ticker">
  <div id="ticker-text">
    第67回梶の葉祭にご来場くださいましてありがとうございます。記録的な猛暑が続いており、熱中症の危険が高まっています。"こまめな水分補給"や"日陰での休憩"など、熱中症対策にご協力お願いします。
  </div>
</div>

<div id="layout">
  <div id="left">
    <div id="list" class="crowd-grid">読み込み中...</div>
    <div class="legend">
      <p>凡例：<span style="color:#2e7d32">○ 空いている</span>　<span style="color:#f9a825">△ 少し混雑</span>　<span style="color:#c62828">✕ 混雑</span></p>
      <p style="font-size:14px; font-weight:normal; color:#666;">※混雑状況はあくまでも目安です。今現在の状態であるため、すぐに変わる可能性もあります。</p>
    </div>
  </div>

  <div id="right">
    <div id="nowTime">現在時刻 --:--</div>
    <h2>交通案内</h2>
    <p class="traffic-note">※詳細につきましては各運行会社のホームページをご確認ください。</p>
    <div class="btns">
      <button id="btnWeek" onclick="setMode('weekday')" class="active">平日</button>
      <button id="btnHoliday" onclick="setMode('holiday')">休日</button>
    </div>
    <div id="trainBoard"></div>
    <hr>
    <div id="busBoard"></div>
  </div>
</div>
  <!-- 緊急画面 -->
<div id="emergencyScreen">
  <div id="emBox">
    <h1 id="emTitle"></h1>
    <p id="emMessage"></p>
    <div id="emVideo"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDTHN-YfAJz86NgNAaldixubGfDZwRgnKw",
  authDomain: "bunkasai-info-59212.firebaseapp.com",
  databaseURL: "https://bunkasai-info-59212-default-rtdb.firebaseio.com",
  projectId: "bunkasai-info-59212",
  storageBucket: "bunkasai-info-59212.firebasestorage.app",
  messagingSenderId: "775251011941",
  appId: "1:775251011941:web:7237a990162fa00217198c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let mode = "weekday";
let transportCache = null;
let lastRenderTime = -1;

function timeToMin(t){
  if(!t || typeof t !== "string") return 0;
  const [h,m] = t.split(":").map(Number);
  return h * 60 + m;
}

function nowMin(){
  const d = new Date();
  return d.getHours() * 60 + d.getMinutes();
}

function getNextItems(list, limit = 3){
  if (!list || !Array.isArray(list)) return [];
  const now = nowMin();
  return list
    .filter(item => {
      const t = (typeof item === 'string') ? item : item.time;
      return timeToMin(t) >= now;
    })
    .slice(0, limit);
}

function renderTransport() {
  if (!transportCache) return;
  const currentMin = nowMin();
  if (currentMin === lastRenderTime) return;
  lastRenderTime = currentMin;

  let trainHTML = "";
  let busHTML = "";
  const data = transportCache;

  if (data.train) {
    for (let k in data.train) {
      const st = data.train[k];
      const d = st[mode] || { up: [], down: [] };
      const u = getNextItems(d.up, 3);
      const dn = getNextItems(d.down, 3);

      trainHTML += `<div class="jr-board"><h3>（長野電鉄） ${st.name}</h3>`;
      trainHTML += `<div><b>⬆ 上り 長野方面</b></div>`;
      if(u.length > 0){
        trainHTML += `<div class="jr-row" style="background: #111; border-left: 4px solid #0af;"><div class="jr-time" style="font-size:30px;">${u[0].time}</div><div class="jr-dest" style="font-size:30px;color:#ff9800;">${u[0].dest}</div></div><div class="stops fixed">停車駅 ： ${u[0].stops ? u[0].stops.join(" → ") : "各駅停車"}</div>`;
        u.slice(1).forEach(t => { trainHTML += `<div class="jr-row" style="opacity:0.7;"><div class="jr-time">${t.time}</div><div class="jr-dest">${t.dest}</div></div>`; });
      } else { trainHTML += `<div class="jr-row" style="color:#888;">本日の運行は終了しました</div>`; }

      trainHTML += `<br><div><b>⬇ 下り 須坂・信州中野・湯田中方面</b></div>`;
      if(dn.length > 0){
        trainHTML += `<div class="jr-row" style="background: #111; border-left: 4px solid #f44;"><div class="jr-time" style="font-size:30px;">${dn[0].time}</div><div class="jr-dest" style="font-size:30px;color:#ff9800;">${dn[0].dest}</div></div><div class="stops"><span>停車駅 ： ${dn[0].stops ? dn[0].stops.join(" → ") : "各駅停車"}</span></div>`;
        dn.slice(1).forEach(t => { trainHTML += `<div class="jr-row" style="opacity:0.7;"><div class="jr-time">${t.time}</div><div class="jr-dest">${t.dest}</div></div>`; });
      } else { trainHTML += `<div class="jr-row" style="color:#888;">本日の運行は終了しました</div>`; }
      trainHTML += `</div>`;
    }
  }

  if (data.bus) {
    for (let k in data.bus) {
      const stop = data.bus[k];
      const bd = stop[mode] || { toStation: [], toTown: [] };
      const toS = getNextItems(bd.toStation, 3);
      const toT = getNextItems(bd.toTown, 3);

      busHTML += `
        <div class="jr-board">
          <h3>（アルピコ交通） ${stop.name}</h3>
          <div class="bus-columns">
            <div class="bus-col">
              <b>城山小学校前：長野駅・松岡・大塚南方面</b>
              ${toS.length ? toS.map(t => `
                <div class="schedule-card">
                  <div class="jr-time" style="width:80px;">${t.time}</div>
                  <div class="jr-dest">
                    <span style="color:#0af; font-size:20px; border:1px solid #0af; padding:0 2px; margin-right:4px;">${t.line}</span>
                    ${t.dest}
                    <div style="font-size:12px; color:#aaa; margin-left:20px;">${t.via || ""}</div>
                  </div>
                </div>`).join("") : `<div class="jr-row">本日の運行は終了しました</div>`}
            </div>
            <div class="bus-col">
              <b>善光寺西：宇木・若槻・飯綱・戸隠方面</b>
              ${toT.length ? toT.map(t => `
                <div class="schedule-card">
                  <div class="jr-time" style="width:80px;">${t.time}</div>
                  <div class="jr-dest">
                    <span style="color:#0af; font-size:20px; border:1px solid #0af; padding:0 2px; margin-right:4px;">${t.line}</span>
                    ${t.dest}
                    <div style="font-size:12px; color:#aaa; margin-left:20px;">${t.via || ""}</div>
                  </div>
                </div>`).join("") : `<div class="jr-row">本日の運行は終了しました</div>`}
            </div>
          </div>
        </div>`;
    }
  }
  document.getElementById("trainBoard").innerHTML = trainHTML;
  document.getElementById("busBoard").innerHTML = busHTML;
  setupStopScroll();
}

function loadTransport(){
  db.ref("transport").once("value", snap => {
    transportCache = snap.val();
    lastRenderTime = -1;
    renderTransport();
  });
}

function setMode(m){
  mode = m;
  document.querySelectorAll(".btns button").forEach(btn=>btn.classList.remove("active"));
  document.getElementById(m==="weekday"?"btnWeek":"btnHoliday").classList.add("active");
  lastRenderTime = -1;
  renderTransport();
}

function setupStopScroll() {
  document.querySelectorAll(".stops:not(.fixed) span").forEach(span => {
    if (span.dataset.running) return;
    span.dataset.running = "true";
    const play = () => {
      if (!document.body.contains(span)) return;
      const boxW = span.parentElement.clientWidth;
      const textW = span.scrollWidth;
      const startPos = boxW;
      const endPos = -textW - 50;
      const duration = (startPos - endPos) / 50; 
      span.style.transition = "none";
      span.style.transform = `translateX(${startPos}px)`;
      span.offsetHeight; 
      span.style.transition = `transform ${duration}s linear`;
      span.style.transform = `translateX(${endPos}px)`;
      setTimeout(play, (duration * 1000) + 5000); 
    };
    play();
  });
}

db.ref("classes").on("value", snap => {
  const data = snap.val();
  if(!data){
    document.getElementById("list").innerHTML = "データがありません";
    return;
  }
  let h1 = "", h2 = "";
  for (let key in data) {
    const item = data[key];
    const s = item.status;
    const sCls = s === "○" ? "ok" : s === "△" ? "mid" : "ng";
    const card = `<div class="card"><div>${item.name}</div><div class="status ${sCls}">${s}</div></div>`;
    if (item.name.includes("1年")) h1 += card;
    else if (item.name.includes("2年")) h2 += card;
  }
  document.getElementById("list").innerHTML = h1 + h2;
});

loadTransport();
setInterval(renderTransport, 10000);
setInterval(loadTransport, 1800000);

function updateNowTime(){
  const d = new Date();
  document.getElementById("nowTime").textContent = `現在時刻　${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
}
setInterval(updateNowTime,1000);
updateNowTime();
// 緊急監視
db.ref("system").on("value", snap=>{

  const d = snap.val();
  if(!d) return;

  if(d.emergency){

    showEmergency(d);

  }else{

    hideEmergency();

  }

});
function showEmergency(d){

  const screen = document.getElementById("emergencyScreen");

  // 通常画面を消す
  document.getElementById("layout").style.display="none";

  screen.style.display="flex";

  if(d.mode==="drill"){
    screen.style.background="#f9a825";
    document.getElementById("emTitle").innerText="⚠ 緊急地震速報訓練中 ⚠";
  }

  if(d.mode==="real"){
    screen.style.background="#c62828";
    document.getElementById("emTitle").innerText="⚠ 緊急地震速報 ⚠";
  }

  document.getElementById("emMessage").innerText = d.message || "";

document.getElementById("emVideo").innerHTML = `
  <div class="video-box">
    <iframe
      src="https://www.youtube.com/embed/ozDXFjwgjYA?autoplay=1&mute=1"
      allow="autoplay"
      allowfullscreen>
    </iframe>
  </div>

  <div style="
    text-align:center;
    font-size:14px;
    color:#eee;
    margin-top:8px;
    opacity:0.8;
  ">
    提供：YouTube「JQuakeチャンネル」<br>
    『【JQuake】地震速報放送24時間』
  </div>
`;
}


function hideEmergency(){

  document.getElementById("emergencyScreen").style.display="none";
  document.getElementById("layout").style.display="grid";
  document.getElementById("emVideo").innerHTML = "";

}
  
</script>
</body>
</html>

