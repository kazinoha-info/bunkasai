<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æ–‡åŒ–ç¥­æ¡ˆå†…</title>
<style>
body{
  margin:0;
  font-family: "Trebuchet", sans-serif;
  background: #eaf3ff;
}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ */
h1{
  background:#ed7d0c;
  color:orange;
  padding:20px;
  margin:0;
  text-align:center;
}

/* ãƒ†ãƒ­ãƒƒãƒ— */
#ticker{
  background:#ed7d0c;
  color:white;
  overflow:hidden;
  white-space:nowrap;
  height:100px;
  line-height:100px;
}

#ticker-text{
  display:inline-block;
  padding-left:100%;
  animation: scroll 60s linear infinite;
  font-size: 32px;       /* â†ã“ã“ã§æ–‡å­—ã®å¤§ãã•ã‚’èª¿æ•´ï¼ˆæ•°å­—ã‚’å¤§ããã™ã‚‹ã¨å­—ã‚‚å¤§ãããªã‚‹ï¼‰ */
  font-weight: bold;     /* â†å¤ªå­—ã«ã™ã‚‹ã¨ã‚ˆã‚Šç›®ç«‹ã¡ã¾ã™ */
}

@keyframes scroll{
  from{ transform: translateX(0); }
  to{ transform: translateX(-100%); }
}


@keyframes stops-scroll {
  from { transform: translateX(var(--start)); }
  to { transform: translateX(var(--end)); }
}

.stops span {
  display: inline-block;
  white-space: nowrap;
  padding-right: 200px; /* ã“ã“ã‚’åºƒã‚ã«ã—ã¦æ¶ˆãˆå»ã‚‹ä½™è£•ã‚’æŒãŸã›ã‚‹ */
  font-size: 28px;
  font-weight: bold;
  color: white;
  will-change: transform;
}
/* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
#layout{
  display:grid;
  grid-template-columns: 3fr 2fr; /* å·¦3ï¼šå³2 */
  height: calc(100vh - 100px);
}

#right h2{
  font-size:28px;
  font-weight:bold;
  color:white;
  background:black;
  padding:8px;
  border-radius:6px;
  text-align:center;
}

/* å·¦ */
#left{
  overflow:auto;
}

#list{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(250px,1fr));
  gap:15px;
  padding:20px;
}

/* ã‚«ãƒ¼ãƒ‰ */
.card{
  background:white;
  border-radius:10px;
  padding:15px;
  box-shadow:0 2px 5px rgba(0,0,0,0.1);
  text-align:center;
  font-size:18px;
}

.status{
  font-size:28px;
  font-weight:bold;
  margin-top:10px;
}

.ok{ color:#2e7d32; }
.mid{ color:#f9a825; }
.ng{ color:#c62828; }

/* å³ */
#right{
  background:#f5f9ff;
  padding:15px;
  border-left:2px solid #bbdefb;

  overflow-y:auto;   /* â†è¿½åŠ  */
}


.btns{
  margin:10px 0;
}

.btns button{
  padding:8px 15px;
  margin-right:5px;
  border:none;
  border-radius:5px;
  background:#1565c0;
  color:white;
  cursor:pointer;
  border-radius:6px;
}

.btns button:hover{
  opacity:0.8;
}

/* æ™‚åˆ» */
.time{
  font-size:20px;
  padding:5px;
  border-bottom:1px solid #ddd;
}

.board{
  background:black;
  color:#ccc;
  font-size:26px;
  padding:15px;
  border-radius:10px;
  font-family: monospace;
}

.row{
  display:grid;
  grid-template-columns: 60px 100px 1fr 80px;
  padding:8px 0;
  border-bottom:1px solid #333;
}


/* é¸æŠä¸­ãƒœã‚¿ãƒ³ */
.btns button.active{
  background:#ff9800;
  color:black;
  font-weight:bold;
}

/* ===== é§…è¡¨ç¤ºãƒœãƒ¼ãƒ‰ ===== */

.station-name{
  text-align:center;
  font-size:28px;
  margin-bottom:15px;
  border-bottom:2px solid white;
  padding-bottom:8px;
}

.jr-title{
  font-size:22px;
  margin:15px 0 5px;
}

.jr-row{
  display:flex;
  justify-content:space-between;
  padding:8px 0;
  border-bottom:1px solid white;
  font-size:20px;
}

.jr-dest{
  margin-left:20px;
}

/* JRé¢¨è¡¨ç¤º */

.jr-board{
  background:black;
  color:#0af;
  font-family: monospace;
  padding:15px;
  border-radius:10px;
  margin-bottom:15px;

  width: 100%;        /* â†è¿½åŠ  */
  box-sizing: border-box; /* â†è¿½åŠ  */
}


.jr-row{
  display:flex;
  font-size:22px;
  padding:5px 0;
  border-bottom:1px solid #333;
}

.jr-time{
  width:80px;
  color:#0af;
}

.jr-dest{
  flex:1;
  color:white;
}

.stops{
  margin-top:10px;
  overflow:hidden;
  white-space:nowrap;
  color:white;
  font-weight:bold;
  position: relative;
}

.stops span{
  display:inline-block;
  padding-left:0;   /* â† 0ã«ã™ã‚‹ */
  font-size:28px;
  font-weight:bold;

  white-space: nowrap;
  will-change: transform;
}

/* è¦‹å‡ºã—ç³»ã‚’å¼·èª¿ */

.jr-board h3{
  font-size:30px;
  font-weight:bold;
  color:white;
  margin:5px 0 10px;
}

.jr-board b{
  font-size:24px;
  font-weight:bold;
  color:white;
}

.stops.fixed{
  overflow: visible;
  white-space: normal;
  animation: none;
  font-size:26px;
}

/* ===== ãƒã‚¹ç”¨ æ¨ªä¸¦ã³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ===== */
.bus-columns{
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
  margin-top: 10px;
}

.bus-col b{
  display: block;
  text-align: center;
  font-size: 22px;
  margin-bottom: 5px;
}

</style>

</head>
<body>

<div id="ticker">
  <div id="ticker-text">
    ç¬¬67å›æ¢¶ã®è‘‰ç¥­ã«ã”æ¥å ´ãã ã•ã„ã¾ã—ã¦ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚è¨˜éŒ²çš„ãªçŒ›æš‘ãŒç¶šã„ã¦ãŠã‚Šã€ç†±ä¸­ç—‡ã®å±é™ºãŒé«˜ã¾ã£ã¦ã„ã¾ã™ã€‚"ã“ã¾ã‚ãªæ°´åˆ†è£œçµ¦"ã‚„"æ—¥é™°ã§ã®ä¼‘æ†©"ãªã©ã€ç†±ä¸­ç—‡å¯¾ç­–ã«ã”å”åŠ›ãŠé¡˜ã„ã—ã¾ã™ã€‚
  </div>
</div>
<div id="layout">

  <!-- å·¦ï¼šã‚¯ãƒ©ã‚¹ -->
  <div id="left">
    <div id="list">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>

  <!-- å³ï¼šæ™‚åˆ»è¡¨ -->
  <div id="right">
  <h2>äº¤é€šæ¡ˆå†…</h2>
  <div class="btns"></div>
    
  <!-- é›»è»Š -->
  <div id="trainBoard"></div>
  <hr>
    
  <!-- ãƒã‚¹ -->
  <div id="busBoard"></div>

</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>


// "9:25" â†’ 565 (åˆ†) ã«å¤‰æ›
function timeToMin(t){
  const [h,m] = t.split(":").map(Number);
  return h*60 + m;
}

// ä»Šã®æ™‚åˆ»ï¼ˆåˆ†ï¼‰
function nowMin(){
  const d = new Date();
  return d.getHours()*60 + d.getMinutes() + d.getSeconds()/60;
}

function getNextTrains(list){
  const now = nowMin();

  return list
    .filter(t => timeToMin(t.time) >= now) // æœªæ¥ã ã‘
    .slice(0,3); // 3æœ¬ã ã‘
}

  // ğŸ”½ Firebaseè¨­å®šï¼ˆå›ã®ã‚„ã¤ç”¨ã«ã‚‚ã†å…¥ã‚Œã¦ã‚ã‚‹ï¼‰
  const firebaseConfig = {
  apiKey: "AIzaSyDTHN-YfAJz86NgNAaldixubGfDZwRgnKw",
  authDomain: "bunkasai-info-59212.firebaseapp.com",
  databaseURL: "https://bunkasai-info-59212-default-rtdb.firebaseio.com",
  projectId: "bunkasai-info-59212",
  storageBucket: "bunkasai-info-59212.firebasestorage.app",
  messagingSenderId: "775251011941",
  appId: "1:775251011941:web:7237a990162fa00217198c"
};


  // Firebaseè¨­å®šãªã©ã¯ãã®ã¾ã¾
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let transportCache = null; // â† ã“ã‚Œã‚’è¿½åŠ ï¼ï¼

// --- çŠ¶æ…‹ç®¡ç†ç”¨ ---
let lastTransportData = ""; 

// 1. ã‚¯ãƒ©ã‚¹æƒ…å ±ã®å–å¾—ï¼ˆã“ã“ã¯ä»Šã®ã¾ã¾ã§OKï¼‰
db.ref("classes").on("value", (snapshot) => {
  const data = snapshot.val();
  let html = "";
  for (let key in data) {
    let statusClass = (data[key].status==="â—‹")?"ok":(data[key].status==="â–³")?"mid":(data[key].status==="Ã—")?"ng":"";
    html += `<div class="card"><div>${data[key].name}</div><div class="status ${statusClass}">${data[key].status}</div></div>`;
  }
  document.getElementById("list").innerHTML = html;
});

// 2. ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
let mode = "weekday";
function setMode(m){
  mode = m;
  document.querySelectorAll(".btns button").forEach(btn=>btn.classList.remove("active"));
  document.getElementById(m==="weekday"?"btnWeek":"btnHoliday").classList.add("active");
  loadTransport(true); // å¼·åˆ¶æ›´æ–°
}

document.querySelector(".btns").innerHTML = `
  <button id="btnWeek" onclick="setMode('weekday')" class="active">å¹³æ—¥</button>
  <button id="btnHoliday" onclick="setMode('holiday')">ä¼‘æ—¥</button>
`;

// 3. äº¤é€šæ¡ˆå†…ï¼ˆã“ã“ãŒä¿®æ­£ã®ã‚­ãƒ¢ï¼‰
// 3. äº¤é€šæ¡ˆå†…ï¼ˆä¿®æ­£ç‰ˆï¼šè¡Œãå…ˆã”ã¨ã®åœè»Šé§…ã‚’è¡¨ç¤ºï¼‰
// 3. äº¤é€šæ¡ˆå†…ï¼ˆé›»è»Šã¨ãƒã‚¹ã®ä¸¡æ–¹ã‚’è¡¨ç¤ºã—ã€é›»è»Šã®åœè»Šé§…ã‚’å€‹åˆ¥åŒ–ï¼‰
// 3. äº¤é€šæ¡ˆå†…ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¤‰æ›´ç‰ˆï¼š1ç•ªç›®ã¨ãã®åœè»Šé§…ã‚’ã‚»ãƒƒãƒˆã«ã™ã‚‹ï¼‰
function loadTransport(force = false){
  db.ref("transport").once("value", snap=>{
    const data = snap.val();
    transportCache = data;   // â† ã“ã‚Œã‚’è¿½åŠ ï¼ï¼
    const dataStr = JSON.stringify(data) + mode;


    if(!force && dataStr === lastTransportData) return;
    lastTransportData = dataStr;

    let trainHTML = "";
    let busHTML = "";

    if(data.train){
      for(let k in data.train){
        const st = data.train[k];
        const d = st[mode] || { up: [], down: [] };

        trainHTML += `<div class="jr-board"><h3>ï¼ˆé•·é‡é›»é‰„ï¼‰ ${st.name}</h3>`;

        // --- ä¸Šã‚Šï¼ˆé•·é‡æ–¹é¢ï¼‰ ---
        const u = getNextTrains(d.up || []);
        trainHTML += `<div><b>â¬† ä¸Šã‚Š é•·é‡æ–¹é¢</b></div>`;
        if(u.length > 0) {
          // 1ç•ªç›®ï¼ˆå¤§ããè¡¨ç¤ºï¼‰
          trainHTML += `
            <div class="jr-row" style="background: #111; border-left: 4px solid #0af;">
              <div class="jr-time" style="font-size: 30px; width: 100px;">${u[0].time}</div>
              <div class="jr-dest" style="font-size: 30px; color: #ff9800;">${u[0].dest}</div>
            </div>
            <div class="stops fixed" style="margin-bottom: 10px; border-bottom: 1px dashed #444; padding-bottom: 5px;">
              åœè»Šé§… â–¶ ${u[0].stops ? u[0].stops.join(" â†’ ") : "å„é§…åœè»Š"}
            </div>
          `;
          // 2ç•ªç›®ãƒ»3ç•ªç›®ï¼ˆå°‘ã—å°ã•ãä¸¦ã¹ã‚‹ï¼‰
          u.slice(1,3).forEach(t=>{
            trainHTML += `
              <div class="jr-row" style="opacity: 0.8; font-size: 20px;">
                <div class="jr-time">${t.time}</div>
                <div class="jr-dest">${t.dest}</div>
              </div>
            `;
          });
        }

        trainHTML += `<br><div><b>â¬‡ ä¸‹ã‚Š ä¿¡å·ä¸­é‡ãƒ»æ¹¯ç”°ä¸­æ–¹é¢</b></div>`;

        // --- ä¸‹ã‚Šï¼ˆä¸­é‡æ–¹é¢ï¼‰ ---
        const dn = getNextTrains(d.down || []);
        if(dn.length > 0) {
          // 1ç•ªç›®ï¼ˆå¤§ããè¡¨ç¤º ï¼‹ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åœè»Šé§…ï¼‰
          trainHTML += `
            <div class="jr-row" style="background: #111; border-left: 4px solid #f44;">
              <div class="jr-time" style="font-size: 30px; width: 100px;">${dn[0].time}</div>
              <div class="jr-dest" style="font-size: 30px; color: #ff9800;">${dn[0].dest}</div>
            </div>
            <div class="stops">
              <span>åœè»Šé§… â–¶ ${dn[0].stops ? dn[0].stops.join(" â†’ ") : "å„é§…åœè»Š"}</span>
            </div>
            <div style="height: 10px; border-bottom: 1px dashed #444; margin-bottom: 10px;"></div>
          `;
          // 2ç•ªç›®ãƒ»3ç•ªç›®
          dn.slice(1,3).forEach(t=>{
            trainHTML += `
              <div class="jr-row" style="opacity: 0.8; font-size: 20px;">
                <div class="jr-time">${t.time}</div>
                <div class="jr-dest">${t.dest}</div>
              </div>
            `;
          });
        }
        trainHTML += `</div>`;
      }
    }

    /* ãƒã‚¹è¡¨ç¤ºï¼šå¤‰æ›´ãªã—ï¼ˆå‰å›ã¨åŒã˜ãƒ«ãƒ¼ãƒ—å‡¦ç†ã‚’è¨˜è¿°ï¼‰ */
    if(data.bus){
      for(let k in data.bus){
        const stop = data.bus[k];
        const bd = stop[mode] || { toStation: [], toTown: [] };
        busHTML += `
          <div class="jr-board">
            <h3>ï¼ˆã‚¢ãƒ«ãƒ”ã‚³äº¤é€šï¼‰ ${stop.name}</h3>
            <div class="bus-columns">
              <div class="bus-col">
                <b>â–¶ é§…æ–¹é¢</b>
                ${bd.toStation.map(t=>`<div class="jr-row"><div class="jr-time">${t}</div><div class="jr-dest">é§…è¡Œã</div></div>`).join("")}
              </div>
              <div class="bus-col">
                <b>â–¶ ç”ºæ–¹é¢</b>
                ${bd.toTown.map(t=>`<div class="jr-row"><div class="jr-time">${t}</div><div class="jr-dest">ç”ºè¡Œã</div></div>`).join("")}
              </div>
            </div>
          </div>`;
      }
    }

    document.getElementById("trainBoard").innerHTML = trainHTML;
    document.getElementById("busBoard").innerHTML = busHTML;
    setupStopScroll();
  });
}

// 4. ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å‡¦ç†ï¼ˆã‚ˆã‚Šå …ç‰¢ãªãƒ­ã‚¸ãƒƒã‚¯ï¼‰
function setupStopScroll() {
  document.querySelectorAll(".stops:not(.fixed) span").forEach(span => {
    let timerId = null;

    const play = () => {
      // DOMã‹ã‚‰æ¶ˆãˆã¦ã„ãŸã‚‰çµ‚äº†
      if (!document.body.contains(span)) return;

      const parent = span.parentElement;
      const textW = span.scrollWidth; 
      const boxW = parent.clientWidth;

      const startPos = boxW;
      const endPos = -textW - 10; // å®Œå…¨ã«æ¶ˆã—å»ã‚‹ãŸã‚ã«å°‘ã—ä½™è£•ã‚’æŒãŸã›ã‚‹

      const speed = 70; // JRé¢¨ã®é€Ÿã•
      const duration = (startPos - endPos) / speed;

      // ãƒªã‚»ãƒƒãƒˆ
      span.style.transition = "none";
      span.style.transform = `translateX(${startPos}px)`;
      
      // å¼·åˆ¶ãƒªãƒ•ãƒ­ãƒ¼
      span.offsetHeight;

      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
      span.style.transition = `transform ${duration}s linear`;
      span.style.transform = `translateX(${endPos}px)`;

      // å®Œå…¨ã«æ¶ˆãˆå»ã£ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§5ç§’å¾…æ©Ÿã—ã¦ãƒ«ãƒ¼ãƒ—
      timerId = setTimeout(() => {
        play();
      }, (duration * 1000) + 5000);
    };

    play();
  });
}

// åˆå›å®Ÿè¡Œ
loadTransport();

// 30ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒå¤‰ã‚ã£ãŸæ™‚ã ã‘æ›¸ãæ›ã‚ã‚‹ï¼‰
setInterval(loadTransport, 5000);
</script>

</body>
</html>


