<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>文化祭案内</title>
<style>
/* スタイル設定（変更なし） */
body{ margin:0; font-family: "Trebuchet", sans-serif; background: #eaf3ff; }
#ticker{ background:#ed7d0c; color:white; overflow:hidden; white-space:nowrap; height:100px; line-height:100px; }
#ticker-text{ display:inline-block; padding-left:100%; animation: scroll 60s linear infinite; font-size: 32px; font-weight: bold; }
@keyframes scroll{ from{ transform: translateX(0); } to{ transform: translateX(-100%); } }
#layout{ display:grid; grid-template-columns: 3fr 2fr; height: calc(100vh - 100px); }
#right h2{ font-size:28px; font-weight:bold; color:white; background:black; padding:8px; border-radius:6px; text-align:center; }
#left{ overflow:auto; }
#list{ display:grid; grid-template-columns: repeat(auto-fill, minmax(250px,1fr)); gap:15px; padding:20px; }
.card{ background:white; border-radius:10px; padding:15px; box-shadow:0 2px 5px rgba(0,0,0,0.1); text-align:center; font-size:18px; }
.status{ font-size:28px; font-weight:bold; margin-top:10px; }
.ok{ color:#2e7d32; } .mid{ color:#f9a825; } .ng{ color:#c62828; }
#right{ background:#f5f9ff; padding:15px; border-left:2px solid #bbdefb; overflow-y:auto; }
.btns{ margin:10px 0; }
.btns button{ padding:8px 15px; margin-right:5px; border:none; border-radius:5px; background:#1565c0; color:white; cursor:pointer; border-radius:6px;}
.btns button.active{ background:#ff9800; color:black; font-weight:bold; }
.jr-board{ background:black; color:#0af; font-family: monospace; padding:15px; border-radius:10px; margin-bottom:15px; width: 100%; box-sizing: border-box; }
.jr-row{ display:flex; font-size:22px; padding:5px 0; border-bottom:1px solid #333; }
.jr-time{ width:100px; color:#0af; }
.jr-dest{ flex:1; color:white; }
.stops{ margin-top:10px; overflow:hidden; white-space:nowrap; color:white; font-weight:bold; position: relative; }
.stops span{ display:inline-block; font-size:28px; white-space: nowrap; will-change: transform; }
.jr-board h3{ font-size:30px; font-weight:bold; color:white; margin:5px 0 10px; }
.jr-board b{ font-size:24px; font-weight:bold; color:white; }
.stops.fixed{ overflow: visible; white-space: normal; animation: none; font-size:26px; }
.bus-columns{ display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
.bus-col b{ display: block; text-align: center; font-size: 22px; margin-bottom: 5px; }
</style>
</head>
<body>

<div id="ticker">
  <div id="ticker-text">
    第67回梶の葉祭にご来場くださいましてありがとうございます。記録的な猛暑が続いており、熱中症の危険が高まっています。"こまめな水分補給"や"日陰での休憩"など、熱中症対策にご協力お願いします。
  </div>
</div>

<div id="layout">
  <div id="left"><div id="list">読み込み中...</div></div>
  <div id="right">
    <h2>交通案内</h2>
    <div class="btns">
      <button id="btnWeek" onclick="setMode('weekday')" class="active">平日</button>
      <button id="btnHoliday" onclick="setMode('holiday')">休日</button>
    </div>
    <div id="trainBoard"></div>
    <hr>
    <div id="busBoard"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// --- 1. 基本設定（復活させました） ---
const firebaseConfig = {
  apiKey: "AIzaSyDTHN-YfAJz86NgNAaldixubGfDZwRgnKw",
  authDomain: "bunkasai-info-59212.firebaseapp.com",
  databaseURL: "https://bunkasai-info-59212-default-rtdb.firebaseio.com",
  projectId: "bunkasai-info-59212",
  storageBucket: "bunkasai-info-59212.firebasestorage.app",
  messagingSenderId: "775251011941",
  appId: "1:775251011941:web:7237a990162fa00217198c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let mode = "weekday";
let transportCache = null;
let lastRenderTime = -1;

// --- 2. 時刻計算用 ---
function timeToMin(t){
  if(!t) return 0;
  const [h,m] = t.split(":").map(Number);
  return h * 60 + m;
}
function nowMin(){
  const d = new Date();
  return d.getHours() * 60 + d.getMinutes();
}
function getNextItems(list, limit = 3){
  const now = nowMin();
  return (list || [])
    .filter(t => {
      const targetTime = typeof t === 'string' ? t : t.time;
      return timeToMin(targetTime) >= now;
    })
    .slice(0, limit);
}

// --- 3. 表示処理 ---
function renderTransport() {
  if (!transportCache) return;
  const currentMin = nowMin();
  if (currentMin === lastRenderTime) return;
  lastRenderTime = currentMin;

  let trainHTML = "";
  let busHTML = "";
  const data = transportCache;

  if (data.train) {
    for (let k in data.train) {
      const st = data.train[k];
      const d = st[mode] || { up: [], down: [] };
      const u = getNextItems(d.up);
      const dn = getNextItems(d.down);

      trainHTML += `<div class="jr-board"><h3>（長野電鉄） ${st.name}</h3>`;
      trainHTML += `<div><b>⬆ 上り 長野方面</b></div>`;
      if(u.length > 0){
        trainHTML += `<div class="jr-row" style="background: #111; border-left: 4px solid #0af;"><div class="jr-time" style="font-size:30px;">${u[0].time}</div><div class="jr-dest" style="font-size:30px;color:#ff9800;">${u[0].dest}</div></div><div class="stops fixed">停車駅 ▶ ${u[0].stops ? u[0].stops.join(" → ") : "各駅停車"}</div>`;
        u.slice(1).forEach(t => { trainHTML += `<div class="jr-row" style="opacity:0.7;"><div class="jr-time">${t.time}</div><div class="jr-dest">${t.dest}</div></div>`; });
      } else { trainHTML += `<div class="jr-row" style="color:#888;">本日の運転は終了しました</div>`; }

      trainHTML += `<br><div><b>⬇ 下り 中野・湯田中方面</b></div>`;
      if(dn.length > 0){
        trainHTML += `<div class="jr-row" style="background: #111; border-left: 4px solid #f44;"><div class="jr-time" style="font-size:30px;">${dn[0].time}</div><div class="jr-dest" style="font-size:30px;color:#ff9800;">${dn[0].dest}</div></div><div class="stops"><span>停車駅 ▶ ${dn[0].stops ? dn[0].stops.join(" → ") : "各駅停車"}</span></div>`;
        dn.slice(1).forEach(t => { trainHTML += `<div class="jr-row" style="opacity:0.7;"><div class="jr-time">${t.time}</div><div class="jr-dest">${t.dest}</div></div>`; });
      } else { trainHTML += `<div class="jr-row" style="color:#888;">本日の運転は終了しました</div>`; }
      trainHTML += `</div>`;
    }
  }

  if (data.bus) {
    for (let k in data.bus) {
      const stop = data.bus[k];
      const bd = stop[mode] || { toStation: [], toTown: [] };
      const toS = getNextItems(bd.toStation, 4);
      const toT = getNextItems(bd.toTown, 4);
      busHTML += `<div class="jr-board"><h3>（アルピコ交通） ${stop.name}</h3><div class="bus-columns"><div class="bus-col"><b>▶ 駅方面</b>${toS.length ? toS.map(t => `<div class="jr-row"><div class="jr-time">${t}</div><div class="jr-dest">駅行き</div></div>`).join("") : "---"}</div><div class="bus-col"><b>▶ 町方面</b>${toT.length ? toT.map(t => `<div class="jr-row"><div class="jr-time">${t}</div><div class="jr-dest">町行き</div></div>`).join("") : "---"}</div></div></div>`;
    }
  }
  document.getElementById("trainBoard").innerHTML = trainHTML;
  document.getElementById("busBoard").innerHTML = busHTML;
  setupStopScroll();
}

function loadTransport(){
  db.ref("transport").once("value", snap => {
    transportCache = snap.val();
    lastRenderTime = -1;
    renderTransport();
  });
}

function setMode(m){
  mode = m;
  document.querySelectorAll(".btns button").forEach(btn=>btn.classList.remove("active"));
  document.getElementById(m==="weekday"?"btnWeek":"btnHoliday").classList.add("active");
  lastRenderTime = -1;
  renderTransport();
}

function setupStopScroll() {
  document.querySelectorAll(".stops:not(.fixed) span").forEach(span => {
    if (span.dataset.running) return;
    span.dataset.running = "true";
    const play = () => {
      if (!document.body.contains(span)) return;
      const boxW = span.parentElement.clientWidth;
      const textW = span.scrollWidth;
      const startPos = boxW;
      const endPos = -textW - 50;
      const duration = (startPos - endPos) / 70;
      span.style.transition = "none";
      span.style.transform = `translateX(${startPos}px)`;
      span.offsetHeight; 
      span.style.transition = `transform ${duration}s linear`;
      span.style.transform = `translateX(${endPos}px)`;
      setTimeout(play, (duration * 1000) + 2000);
    };
    play();
  });
}

// 混雑表示の復活
db.ref("classes").on("value", snap => {
  const data = snap.val();
  let html = "";
  for (let key in data) {
    let statusClass = (data[key].status==="○")?"ok":(data[key].status==="△")?"mid":(data[key].status==="×")?"ng":"";
    html += `<div class="card"><div>${data[key].name}</div><div class="status ${statusClass}">${data[key].status}</div></div>`;
  }
  document.getElementById("list").innerHTML = html;
});

// 定期実行（10秒ごとにチェック）
loadTransport();
setInterval(renderTransport, 10000); 
setInterval(loadTransport, 1800000);
</script>

</body>
</html>
