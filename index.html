<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æ–‡åŒ–ç¥­æ¡ˆå†…</title>
<style>
/* ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®šï¼ˆã”æç¤ºã®ã‚‚ã®ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€åœè»Šé§…ã®è¡¨ç¤ºå´©ã‚Œã®ã¿ä¿®æ­£ï¼‰ */
body{
  margin:0;
  font-family: "Segoe UI", "Noto Sans JP", sans-serif;
  background: linear-gradient(180deg,#f7f9fc,#eaf3ff);
}
#ticker{
  background: linear-gradient(90deg,#ff9800,#ff6f00);
  color:white;
  overflow:hidden;
  white-space:nowrap;
  height:80px;
  line-height:80px;
  box-shadow:0 2px 8px rgba(0,0,0,0.2);
}
#ticker-text{
  display:inline-block;
  min-width:200%;
  padding-left:100%;
  animation: scroll 60s linear infinite;
  font-size:26px;
  font-weight:600;
}
@keyframes scroll{ from{ transform: translateX(0); } to{ transform: translateX(-100%); } }
#layout{ display:grid; grid-template-columns: 3fr 2fr; height: calc(100vh - 100px); }

#left{ overflow:auto; padding:20px; }
#right{
  background:white;
  margin:15px;
  border-radius:15px;
  padding:20px;
  box-shadow:0 4px 12px rgba(0,0,0,0.15);
  overflow-y:auto;
}

/* æ··é›‘è¡¨ç¤º */
.crowd-grid{ display:grid; grid-template-columns: repeat(2, 1fr); gap:16px; }
.card{
  background: #005c3c;
  color:white;
  border-radius:12px;
  padding:18px;
  height: 55px;
  box-shadow:0 3px 8px rgba(0,0,0,0.25);
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:55px;
  font-weight:bold;
}
.status{ font-size:40px; font-weight:bold; width:50px; height:50px; border-radius:6px; display:flex; justify-content:center; align-items:center; }
.ok{ background:#2e7d32; color:white; } 
.mid{ background:#f9a825; color:#333; } 
.ng{ background:#c62828; color:white; }

#right h2{ font-size:28px; font-weight:bold; color:white; background:black; padding:8px; border-radius:6px; text-align:center; margin-top:5px; }
.btns{ margin:10px 0; }
.btns button{ background: #eee; color:#333; font-weight:600; border-radius:20px; padding:6px 16px; border:none; cursor:pointer; }
.btns button.active{ background:#ff9800; color:white; }

.jr-board{
  background: linear-gradient(180deg,#050505,#181818);
  color:#00c3ff;
  border-radius:15px;
  padding:18px;
  margin-bottom:18px;
  box-shadow:0 0 12px rgba(0,195,255,0.25);
}
.jr-row{ display:flex; font-size:22px; padding:5px 0; border-bottom:1px solid #333; }
.jr-time{ width:100px; color:white; font-weight:bold; font-size: 20px; }
.jr-dest{ flex:1; color:white; font-size: 20px; }

/* â˜…ã“ã“ã‚’ä¿®æ­£ï¼šåœè»Šé§…ãŒåŠåˆ†è¦‹ãˆãªã„å•é¡Œã‚’è§£æ¶ˆâ˜… */
.stops{ 
  margin-top:10px; 
  overflow:hidden; 
  white-space:nowrap; 
  color:white; 
  font-weight:bold; 
  position: relative; 
  height: 40px;      /* é«˜ã•ã‚’ååˆ†ã«ç¢ºä¿ */
  line-height: 40px; /* æ–‡å­—ãŒä¸Šä¸‹ä¸­å¤®ã«æ¥ã‚‹ã‚ˆã†ã« */
}
.stops span{ 
  display:inline-block; 
  font-size:28px; 
  white-space: nowrap; 
  will-change: transform; 
  position: absolute; 
  top: 0;            /* ä¸Šã«å¼µã‚Šä»˜ã‹ãªã„ã‚ˆã†ã«å›ºå®š */
}
.stops.fixed{ 
  overflow: visible; 
  white-space: normal; 
  height: auto;      /* å›ºå®šè¡¨ç¤ºã¯é«˜ã•è‡ªå‹• */
  line-height: 1.4; 
  font-size:26px; 
  position: static; 
}

.jr-board h3{ font-size:30px; font-weight:bold; color:white; margin:5px 0 10px; }
.jr-board b{ font-size:24px; font-weight:bold; color:white; }
.bus-columns{ display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
.bus-col b{ display: block; text-align: center; font-size: 22px; margin-bottom: 5px; color: #ffae00; }

#nowTime{
  text-align:center;
  font-size:24px;
  font-weight:bold;
  color:white;
  background:#111;
  padding:8px;
  border-radius:10px;
  margin-bottom:10px;
  letter-spacing:1px;
}
.schedule-card{
  background:#111;
  border-radius:10px;
  padding:8px 10px;
  margin:6px 0;
  display:flex;
  align-items:center;
  box-shadow:0 2px 6px rgba(0,0,0,0.4);
}
.legend{
  grid-column: span 2;
  margin-top:15px;
  font-size:17px;
  color:#333;
  text-align:center;
  font-weight:bold;
}
.traffic-note{ font-size:12px; color:#aaa; text-align:center; margin-top:10px; }
#emergencyScreen{
  position:fixed;
  top:0;left:0;
  width:100%;
  height:100%;
  background:#c62828;
  color:white;
  display:none;
  justify-content:center;
  align-items:center;
  z-index:9999;
}

#emBox{
  text-align:center;
  max-width:90%;
}

#emTitle{
  font-size:60px;
}

#emMessage{
  font-size:28px;
  margin:20px 0;
}
</style>
</head>
<body>

<div id="ticker">
  <div id="ticker-text">
    ç¬¬67å›æ¢¶ã®è‘‰ç¥­ã«ã”æ¥å ´ãã ã•ã„ã¾ã—ã¦ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚è¨˜éŒ²çš„ãªçŒ›æš‘ãŒç¶šã„ã¦ãŠã‚Šã€ç†±ä¸­ç—‡ã®å±é™ºãŒé«˜ã¾ã£ã¦ã„ã¾ã™ã€‚"ã“ã¾ã‚ãªæ°´åˆ†è£œçµ¦"ã‚„"æ—¥é™°ã§ã®ä¼‘æ†©"ãªã©ã€ç†±ä¸­ç—‡å¯¾ç­–ã«ã”å”åŠ›ãŠé¡˜ã„ã—ã¾ã™ã€‚
  </div>
</div>

<div id="layout">
  <div id="left">
    <div id="list" class="crowd-grid">èª­ã¿è¾¼ã¿ä¸­...</div>
    <div class="legend">
      <p>å‡¡ä¾‹ï¼š<span style="color:#2e7d32">â—‹ ç©ºã„ã¦ã„ã‚‹</span>ã€€<span style="color:#f9a825">â–³ å°‘ã—æ··é›‘</span>ã€€<span style="color:#c62828">âœ• æ··é›‘</span></p>
      <p style="font-size:14px; font-weight:normal; color:#666;">â€»æ··é›‘çŠ¶æ³ã¯ã‚ãã¾ã§ã‚‚ç›®å®‰ã§ã™ã€‚ä»Šç¾åœ¨ã®çŠ¶æ…‹ã§ã‚ã‚‹ãŸã‚ã€ã™ãã«å¤‰ã‚ã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚Šã¾ã™ã€‚</p>
    </div>
  </div>

  <div id="right">
    <div id="nowTime">ç¾åœ¨æ™‚åˆ» --:--</div>
    <h2>äº¤é€šæ¡ˆå†…</h2>
    <p class="traffic-note">â€»è©³ç´°ã«ã¤ãã¾ã—ã¦ã¯å„é‹è¡Œä¼šç¤¾ã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‚’ã”ç¢ºèªãã ã•ã„ã€‚</p>
    <div class="btns">
      <button id="btnWeek" onclick="setMode('weekday')" class="active">å¹³æ—¥</button>
      <button id="btnHoliday" onclick="setMode('holiday')">ä¼‘æ—¥</button>
    </div>
    <div id="trainBoard"></div>
    <hr>
    <div id="busBoard"></div>
  </div>
</div>
  <!-- ç·Šæ€¥ç”»é¢ -->
<div id="emergencyScreen">
  <div id="emBox">
    <h1 id="emTitle"></h1>
    <p id="emMessage"></p>
    <div id="emVideo"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDTHN-YfAJz86NgNAaldixubGfDZwRgnKw",
  authDomain: "bunkasai-info-59212.firebaseapp.com",
  databaseURL: "https://bunkasai-info-59212-default-rtdb.firebaseio.com",
  projectId: "bunkasai-info-59212",
  storageBucket: "bunkasai-info-59212.firebasestorage.app",
  messagingSenderId: "775251011941",
  appId: "1:775251011941:web:7237a990162fa00217198c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let mode = "weekday";
let transportCache = null;
let lastRenderTime = -1;

function timeToMin(t){
  if(!t || typeof t !== "string") return 0;
  const [h,m] = t.split(":").map(Number);
  return h * 60 + m;
}

function nowMin(){
  const d = new Date();
  return d.getHours() * 60 + d.getMinutes();
}

function getNextItems(list, limit = 3){
  if (!list || !Array.isArray(list)) return [];
  const now = nowMin();
  return list
    .filter(item => {
      const t = (typeof item === 'string') ? item : item.time;
      return timeToMin(t) >= now;
    })
    .slice(0, limit);
}

function renderTransport() {
  if (!transportCache) return;
  const currentMin = nowMin();
  if (currentMin === lastRenderTime) return;
  lastRenderTime = currentMin;

  let trainHTML = "";
  let busHTML = "";
  const data = transportCache;

  if (data.train) {
    for (let k in data.train) {
      const st = data.train[k];
      const d = st[mode] || { up: [], down: [] };
      const u = getNextItems(d.up, 3);
      const dn = getNextItems(d.down, 3);

      trainHTML += `<div class="jr-board"><h3>ï¼ˆé•·é‡é›»é‰„ï¼‰ ${st.name}</h3>`;
      trainHTML += `<div><b>â¬† ä¸Šã‚Š é•·é‡æ–¹é¢</b></div>`;
      if(u.length > 0){
        trainHTML += `<div class="jr-row" style="background: #111; border-left: 4px solid #0af;"><div class="jr-time" style="font-size:30px;">${u[0].time}</div><div class="jr-dest" style="font-size:30px;color:#ff9800;">${u[0].dest}</div></div><div class="stops fixed">åœè»Šé§… ï¼š ${u[0].stops ? u[0].stops.join(" â†’ ") : "å„é§…åœè»Š"}</div>`;
        u.slice(1).forEach(t => { trainHTML += `<div class="jr-row" style="opacity:0.7;"><div class="jr-time">${t.time}</div><div class="jr-dest">${t.dest}</div></div>`; });
      } else { trainHTML += `<div class="jr-row" style="color:#888;">æœ¬æ—¥ã®é‹è»¢ã¯çµ‚äº†ã—ã¾ã—ãŸ</div>`; }

      trainHTML += `<br><div><b>â¬‡ ä¸‹ã‚Š é ˆå‚ãƒ»ä¿¡å·ä¸­é‡ãƒ»æ¹¯ç”°ä¸­æ–¹é¢</b></div>`;
      if(dn.length > 0){
        trainHTML += `<div class="jr-row" style="background: #111; border-left: 4px solid #f44;"><div class="jr-time" style="font-size:30px;">${dn[0].time}</div><div class="jr-dest" style="font-size:30px;color:#ff9800;">${dn[0].dest}</div></div><div class="stops"><span>åœè»Šé§… ï¼š ${dn[0].stops ? dn[0].stops.join(" â†’ ") : "å„é§…åœè»Š"}</span></div>`;
        dn.slice(1).forEach(t => { trainHTML += `<div class="jr-row" style="opacity:0.7;"><div class="jr-time">${t.time}</div><div class="jr-dest">${t.dest}</div></div>`; });
      } else { trainHTML += `<div class="jr-row" style="color:#888;">æœ¬æ—¥ã®é‹è»¢ã¯çµ‚äº†ã—ã¾ã—ãŸ</div>`; }
      trainHTML += `</div>`;
    }
  }

  if (data.bus) {
    for (let k in data.bus) {
      const stop = data.bus[k];
      const bd = stop[mode] || { toStation: [], toTown: [] };
      const toS = getNextItems(bd.toStation, 3);
      const toT = getNextItems(bd.toTown, 3);

      busHTML += `
        <div class="jr-board">
          <h3>ï¼ˆã‚¢ãƒ«ãƒ”ã‚³äº¤é€šï¼‰ ${stop.name}</h3>
          <div class="bus-columns">
            <div class="bus-col">
              <b>åŸå±±å°å­¦æ ¡å‰ï¼šé•·é‡é§…ãƒ»æ¾å²¡ãƒ»å¤§å¡šå—æ–¹é¢</b>
              ${toS.length ? toS.map(t => `
                <div class="schedule-card">
                  <div class="jr-time" style="width:80px;">${t.time}</div>
                  <div class="jr-dest">
                    <span style="color:#0af; font-size:20px; border:1px solid #0af; padding:0 2px; margin-right:4px;">${t.line}</span>
                    ${t.dest}
                    <div style="font-size:12px; color:#aaa; margin-left:20px;">${t.via || ""}</div>
                  </div>
                </div>`).join("") : `<div class="jr-row">çµ‚äº†</div>`}
            </div>
            <div class="bus-col">
              <b>å–„å…‰å¯ºè¥¿ï¼šå®‡æœ¨ãƒ»è‹¥æ§»ãƒ»é£¯ç¶±ãƒ»æˆ¸éš æ–¹é¢</b>
              ${toT.length ? toT.map(t => `
                <div class="schedule-card">
                  <div class="jr-time" style="width:80px;">${t.time}</div>
                  <div class="jr-dest">
                    <span style="color:#0af; font-size:20px; border:1px solid #0af; padding:0 2px; margin-right:4px;">${t.line}</span>
                    ${t.dest}
                    <div style="font-size:12px; color:#aaa; margin-left:20px;">${t.via || ""}</div>
                  </div>
                </div>`).join("") : `<div class="jr-row">çµ‚äº†</div>`}
            </div>
          </div>
        </div>`;
    }
  }
  document.getElementById("trainBoard").innerHTML = trainHTML;
  document.getElementById("busBoard").innerHTML = busHTML;
  setupStopScroll();
}

function loadTransport(){
  db.ref("transport").once("value", snap => {
    transportCache = snap.val();
    lastRenderTime = -1;
    renderTransport();
  });
}

function setMode(m){
  mode = m;
  document.querySelectorAll(".btns button").forEach(btn=>btn.classList.remove("active"));
  document.getElementById(m==="weekday"?"btnWeek":"btnHoliday").classList.add("active");
  lastRenderTime = -1;
  renderTransport();
}

function setupStopScroll() {
  document.querySelectorAll(".stops:not(.fixed) span").forEach(span => {
    if (span.dataset.running) return;
    span.dataset.running = "true";
    const play = () => {
      if (!document.body.contains(span)) return;
      const boxW = span.parentElement.clientWidth;
      const textW = span.scrollWidth;
      const startPos = boxW;
      const endPos = -textW - 50;
      const duration = (startPos - endPos) / 50; 
      span.style.transition = "none";
      span.style.transform = `translateX(${startPos}px)`;
      span.offsetHeight; 
      span.style.transition = `transform ${duration}s linear`;
      span.style.transform = `translateX(${endPos}px)`;
      setTimeout(play, (duration * 1000) + 5000); 
    };
    play();
  });
}

db.ref("classes").on("value", snap => {
  const data = snap.val();
  let h1 = "", h2 = "";
  for (let key in data) {
    const item = data[key];
    const s = item.status;
    const sCls = s === "â—‹" ? "ok" : s === "â–³" ? "mid" : "ng";
    const card = `<div class="card"><div>${item.name}</div><div class="status ${sCls}">${s}</div></div>`;
    if (item.name.includes("1å¹´")) h1 += card;
    else if (item.name.includes("2å¹´")) h2 += card;
  }
  document.getElementById("list").innerHTML = h1 + h2;
});

loadTransport();
setInterval(renderTransport, 10000);
setInterval(loadTransport, 1800000);

function updateNowTime(){
  const d = new Date();
  document.getElementById("nowTime").textContent = `ç¾åœ¨æ™‚åˆ»ã€€${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
}
setInterval(updateNowTime,1000);
updateNowTime();
// ç·Šæ€¥ç›£è¦–
db.ref("system").on("value", snap=>{

  const d = snap.val();
  if(!d) return;

  if(d.emergency){

    showEmergency(d);

  }else{

    hideEmergency();

  }

});
function showEmergency(d){

  const screen = document.getElementById("emergencyScreen");

  screen.style.display="flex";

  if(d.mode==="drill"){
    screen.style.background="#f9a825";
    document.getElementById("emTitle").innerText="âš  é˜²ç½è¨“ç·´ä¸­ âš ";
  }

  if(d.mode==="real"){
    screen.style.background="#c62828";
    document.getElementById("emTitle").innerText="ğŸš¨ ç·Šæ€¥åœ°éœ‡é€Ÿå ± ğŸš¨";
  }

  document.getElementById("emMessage").innerText = d.message || "";
}

function hideEmergency(){
  document.getElementById("emergencyScreen").style.display="none";
}
  
</script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDTHN-YfAJz86NgNAaldixubGfDZwRgnKw",
  authDomain: "bunkasai-info-59212.firebaseapp.com",
  databaseURL: "https://bunkasai-info-59212-default-rtdb.firebaseio.com",
  projectId: "bunkasai-info-59212",
  storageBucket: "bunkasai-info-59212.firebasestorage.app",
  messagingSenderId: "775251011941",
  appId: "1:775251011941:web:7237a990162fa00217198c"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>

<script>

// system ã‚’ç›£è¦–
db.ref("system").on("value", snap => {

  const data = snap.val();

  if(!data) return;

  const screen = document.getElementById("emergencyScreen");
  const msg = document.getElementById("emgMsg");
  const title = document.getElementById("emgTitle");

  if(data.emergency === true){

    // ç·Šæ€¥ON
    screen.style.display = "block";

    if(data.mode === "drill"){
      title.innerText = "âš ï¸ é˜²ç½è¨“ç·´";
    }else{
      title.innerText = "âš ï¸ ç·Šæ€¥åœ°éœ‡é€Ÿå ±";
    }

    msg.innerText = data.message || "";

  }else{

    // é€šå¸¸
    screen.style.display = "none";

  }

});

</script>

<!-- ç·Šæ€¥ç”»é¢ -->
<div id="emergencyScreen" style="
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:#b71c1c;
  color:white;
  z-index:9999;
  text-align:center;
  padding-top:100px;
  font-size:32px;
">

  <h1 id="emgTitle">âš ï¸ ç·Šæ€¥é€Ÿå ±</h1>
  <p id="emgMsg"></p>

</div>
</body>
</html>












