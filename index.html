<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>文化祭案内</title>
<style>
body{
  margin:0;
  font-family: "Trebuchet", sans-serif;
  background: #eaf3ff;
}

/* ヘッダー */
h1{
  background:#ed7d0c;
  color:orange;
  padding:20px;
  margin:0;
  text-align:center;
}

/* テロップ */
#ticker{
  background:#ed7d0c;
  color:white;
  overflow:hidden;
  white-space:nowrap;
  height:100px;
  line-height:100px;
}

#ticker-text{
  display:inline-block;
  padding-left:100%;
  animation: scroll 60s linear infinite;
  font-size: 32px;       /* ←ここで文字の大きさを調整（数字を大きくすると字も大きくなる） */
  font-weight: bold;     /* ←太字にするとより目立ちます */
}

@keyframes scroll{
  from{ transform: translateX(0); }
  to{ transform: translateX(-100%); }
}


@keyframes stops-scroll {
  from { transform: translateX(var(--start)); }
  to { transform: translateX(var(--end)); }
}

.stops span {
  display: inline-block;
  white-space: nowrap;
  padding-right: 200px; /* ここを広めにして消え去る余裕を持たせる */
  font-size: 28px;
  font-weight: bold;
  color: white;
  will-change: transform;
}
/* レイアウト */
#layout{
  display:grid;
  grid-template-columns: 3fr 2fr; /* 左3：右2 */
  height: calc(100vh - 100px);
}

#right h2{
  font-size:28px;
  font-weight:bold;
  color:white;
  background:black;
  padding:8px;
  border-radius:6px;
  text-align:center;
}

/* 左 */
#left{
  overflow:auto;
}

#list{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(250px,1fr));
  gap:15px;
  padding:20px;
}

/* カード */
.card{
  background:white;
  border-radius:10px;
  padding:15px;
  box-shadow:0 2px 5px rgba(0,0,0,0.1);
  text-align:center;
  font-size:18px;
}

.status{
  font-size:28px;
  font-weight:bold;
  margin-top:10px;
}

.ok{ color:#2e7d32; }
.mid{ color:#f9a825; }
.ng{ color:#c62828; }

/* 右 */
#right{
  background:#f5f9ff;
  padding:15px;
  border-left:2px solid #bbdefb;

  overflow-y:auto;   /* ←追加 */
}


.btns{
  margin:10px 0;
}

.btns button{
  padding:8px 15px;
  margin-right:5px;
  border:none;
  border-radius:5px;
  background:#1565c0;
  color:white;
  cursor:pointer;
  border-radius:6px;
}

.btns button:hover{
  opacity:0.8;
}

/* 時刻 */
.time{
  font-size:20px;
  padding:5px;
  border-bottom:1px solid #ddd;
}

.board{
  background:black;
  color:#ccc;
  font-size:26px;
  padding:15px;
  border-radius:10px;
  font-family: monospace;
}

.row{
  display:grid;
  grid-template-columns: 60px 100px 1fr 80px;
  padding:8px 0;
  border-bottom:1px solid #333;
}


/* 選択中ボタン */
.btns button.active{
  background:#ff9800;
  color:black;
  font-weight:bold;
}

/* ===== 駅表示ボード ===== */

.station-name{
  text-align:center;
  font-size:28px;
  margin-bottom:15px;
  border-bottom:2px solid white;
  padding-bottom:8px;
}

.jr-title{
  font-size:22px;
  margin:15px 0 5px;
}

.jr-row{
  display:flex;
  justify-content:space-between;
  padding:8px 0;
  border-bottom:1px solid white;
  font-size:20px;
}

.jr-dest{
  margin-left:20px;
}

/* JR風表示 */

.jr-board{
  background:black;
  color:#0af;
  font-family: monospace;
  padding:15px;
  border-radius:10px;
  margin-bottom:15px;

  width: 100%;        /* ←追加 */
  box-sizing: border-box; /* ←追加 */
}


.jr-row{
  display:flex;
  font-size:22px;
  padding:5px 0;
  border-bottom:1px solid #333;
}

.jr-time{
  width:80px;
  color:#0af;
}

.jr-dest{
  flex:1;
  color:white;
}

.stops{
  margin-top:10px;
  overflow:hidden;
  white-space:nowrap;
  color:white;
  font-weight:bold;
  position: relative;
}

.stops span{
  display:inline-block;
  padding-left:0;   /* ← 0にする */
  font-size:28px;
  font-weight:bold;

  white-space: nowrap;
  will-change: transform;
}

/* 見出し系を強調 */

.jr-board h3{
  font-size:30px;
  font-weight:bold;
  color:white;
  margin:5px 0 10px;
}

.jr-board b{
  font-size:24px;
  font-weight:bold;
  color:white;
}

.stops.fixed{
  overflow: visible;
  white-space: normal;
  animation: none;
  font-size:26px;
}

/* ===== バス用 横並びレイアウト ===== */
.bus-columns{
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
  margin-top: 10px;
}

.bus-col b{
  display: block;
  text-align: center;
  font-size: 22px;
  margin-bottom: 5px;
}

</style>

</head>
<body>

<div id="ticker">
  <div id="ticker-text">
    第67回梶の葉祭にご来場くださいましてありがとうございます。記録的な猛暑が続いており、熱中症の危険が高まっています。"こまめな水分補給"や"日陰での休憩"など、熱中症対策にご協力お願いします。
  </div>
</div>
<div id="layout">

  <!-- 左：クラス -->
  <div id="left">
    <div id="list">読み込み中...</div>
  </div>

  <!-- 右：時刻表 -->
  <div id="right">
  <h2>交通案内</h2>
  <div class="btns"></div>
    
  <!-- 電車 -->
  <div id="trainBoard"></div>
  <hr>
    
  <!-- バス -->
  <div id="busBoard"></div>

</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>


// "9:25" → 565 (分) に変換
// --- 1. 時刻計算用のユーティリティ ---

// "09:25" → 565 (分) に変換
function timeToMin(t){
  if(!t) return 0;
  const [h,m] = t.split(":").map(Number);
  return h * 60 + m;
}

// 今の時刻（分）を取得
function nowMin(){
  const d = new Date();
  return d.getHours() * 60 + d.getMinutes();
}

// 未来の電車だけを3本抽出する
function getNextTrains(list){
  const now = nowMin();
  return list
    .filter(t => timeToMin(t.time) >= now) // 現在時刻以降の列車のみ
    .sort((a, b) => timeToMin(a.time) - timeToMin(b.time)) // 時刻順に並び替え
    .slice(0, 3); // 先頭から3本
}

// --- 2. メインの表示処理 ---

let transportCache = null; // Firebaseから取得したデータを保持しておく変数
let lastRenderTime = -1;   // 最後に表示更新した時刻（分）

// --- 3. 表示処理 (メイン) ---
function renderTransport() {
  if (!transportCache) return;

  const currentMin = nowMin();
  // 分が変わっていないなら更新しない（点滅防止）
  if (currentMin === lastRenderTime) return;
  lastRenderTime = currentMin;

  let trainHTML = "";
  let busHTML = "";
  const data = transportCache;

  // 【電車】時間が過ぎたものを消して表示
  if (data.train) {
    for (let k in data.train) {
      const st = data.train[k];
      const d = st[mode] || { up: [], down: [] };
      
      // 未来の電車だけを抽出
      const u = getNextItems(d.up);
      const dn = getNextItems(d.down);

      trainHTML += `<div class="jr-board"><h3>（長野電鉄） ${st.name}</h3>`;

      // 上り表示
      trainHTML += `<div><b>⬆ 上り 長野方面</b></div>`;
      if(u.length > 0){
        trainHTML += `
          <div class="jr-row" style="background: #111; border-left: 4px solid #0af;">
            <div class="jr-time" style="font-size: 30px;">${u[0].time}</div>
            <div class="jr-dest" style="font-size: 30px; color: #ff9800;">${u[0].dest}</div>
          </div>
          <div class="stops fixed">停車駅 ▶ ${u[0].stops ? u[0].stops.join(" → ") : "各駅停車"}</div>
        `;
        u.slice(1).forEach(t => {
          trainHTML += `<div class="jr-row" style="opacity: 0.7;"><div class="jr-time">${t.time}</div><div class="jr-dest">${t.dest}</div></div>`;
        });
      } else { trainHTML += `<div class="jr-row" style="color:#888;">本日の運転は終了しました</div>`; }

      trainHTML += `<br><div><b>⬇ 下り 中野・湯田中方面</b></div>`;
      
      // 下り表示
      if(dn.length > 0){
        trainHTML += `
          <div class="jr-row" style="background: #111; border-left: 4px solid #f44;">
            <div class="jr-time" style="font-size: 30px;">${dn[0].time}</div>
            <div class="jr-dest" style="font-size: 30px; color: #ff9800;">${dn[0].dest}</div>
          </div>
          <div class="stops"><span>停車駅 ▶ ${dn[0].stops ? dn[0].stops.join(" → ") : "各駅停車"}</span></div>
        `;
        dn.slice(1).forEach(t => {
          trainHTML += `<div class="jr-row" style="opacity: 0.7;"><div class="jr-time">${t.time}</div><div class="jr-dest">${t.dest}</div></div>`;
        });
      } else { trainHTML += `<div class="jr-row" style="color:#888;">本日の運転は終了しました</div>`; }
      
      trainHTML += `</div>`;
    }
  }

  // 【バス】時間が過ぎたものを消して表示
  if (data.bus) {
    for (let k in data.bus) {
      const stop = data.bus[k];
      const bd = stop[mode] || { toStation: [], toTown: [] };
      // 未来のバスだけを4件ずつ抽出
      const toS = getNextItems(bd.toStation, 4);
      const toT = getNextItems(bd.toTown, 4);

      busHTML += `
        <div class="jr-board">
          <h3>（アルピコ交通） ${stop.name}</h3>
          <div class="bus-columns">
            <div class="bus-col"><b>▶ 駅方面</b>
              ${toS.length ? toS.map(t => `<div class="jr-row"><div class="jr-time">${t}</div><div class="jr-dest">駅行き</div></div>`).join("") : "---"}
            </div>
            <div class="bus-col"><b>▶ 町方面</b>
              ${toT.length ? toT.map(t => `<div class="jr-row"><div class="jr-time">${t}</div><div class="jr-dest">町行き</div></div>`).join("") : "---"}
            </div>
          </div>
        </div>`;
    }
  }

  document.getElementById("trainBoard").innerHTML = trainHTML;
  document.getElementById("busBoard").innerHTML = busHTML;
  setupStopScroll();
}

// データの再取得
function loadTransport(force = false){
  db.ref("transport").once("value", snap => {
    transportCache = snap.val();
    if(force) lastRenderTime = -1; // 強制更新
    renderTransport();
  });
}

// --- 3. 起動とタイマー設定 ---

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// クラス情報のライブ更新
db.ref("classes").on("value", (snapshot) => {
  const data = snapshot.val();
  let html = "";
  for (let key in data) {
    let statusClass = (data[key].status==="○")?"ok":(data[key].status==="△")?"mid":(data[key].status==="×")?"ng":"";
    html += `<div class="card"><div>${data[key].name}</div><div class="status ${statusClass}">${data[key].status}</div></div>`;
  }
  document.getElementById("list").innerHTML = html;
});

// モード切替
function setMode(m){
  mode = m;
  document.querySelectorAll(".btns button").forEach(btn=>btn.classList.remove("active"));
  document.getElementById(m==="weekday"?"btnWeek":"btnHoliday").classList.add("active");
  lastRenderTime = -1; 
  renderTransport();
}

// 初回読み込み
loadTransport();

// 1秒ごとに「今の時刻」をチェックし、分が変わったら表示を更新する
setInterval(renderTransport, 1000);

// 30分ごとにFirebaseから最新データを再取得（念のため）
setInterval(loadTransport, 1800000);

document.querySelector(".btns").innerHTML = `
  <button id="btnWeek" onclick="setMode('weekday')" class="active">平日</button>
  <button id="btnHoliday" onclick="setMode('holiday')">休日</button>
`;

// 3. 交通案内（ここが修正のキモ）
// 3. 交通案内（修正版：行き先ごとの停車駅を表示）
// 3. 交通案内（電車とバスの両方を表示し、電車の停車駅を個別化）
// 3. 交通案内（レイアウト変更版：1番目とその停車駅をセットにする）
function loadTransport(force = false){
  db.ref("transport").once("value", snap=>{
    const data = snap.val();
    transportCache = data;   // ← これを追加！！
    const dataStr = JSON.stringify(data) + mode;


    if(!force && dataStr === lastTransportData) return;
    lastTransportData = dataStr;

    let trainHTML = "";
    let busHTML = "";

    if(data.train){
      for(let k in data.train){
        const st = data.train[k];
        const d = st[mode] || { up: [], down: [] };

        trainHTML += `<div class="jr-board"><h3>（長野電鉄） ${st.name}</h3>`;

        // --- 上り（長野方面） ---
        const u = getNextTrains(d.up || []);
        trainHTML += `<div><b>⬆ 上り 長野方面</b></div>`;
        if(u.length > 0) {
          // 1番目（大きく表示）
          trainHTML += `
            <div class="jr-row" style="background: #111; border-left: 4px solid #0af;">
              <div class="jr-time" style="font-size: 30px; width: 100px;">${u[0].time}</div>
              <div class="jr-dest" style="font-size: 30px; color: #ff9800;">${u[0].dest}</div>
            </div>
            <div class="stops fixed" style="margin-bottom: 10px; border-bottom: 1px dashed #444; padding-bottom: 5px;">
              停車駅 ▶ ${u[0].stops ? u[0].stops.join(" → ") : "各駅停車"}
            </div>
          `;
          // 2番目・3番目（少し小さく並べる）
          u.slice(1,3).forEach(t=>{
            trainHTML += `
              <div class="jr-row" style="opacity: 0.8; font-size: 20px;">
                <div class="jr-time">${t.time}</div>
                <div class="jr-dest">${t.dest}</div>
              </div>
            `;
          });
        }

        trainHTML += `<br><div><b>⬇ 下り 信州中野・湯田中方面</b></div>`;

        // --- 下り（中野方面） ---
        const dn = getNextTrains(d.down || []);
        if(dn.length > 0) {
          // 1番目（大きく表示 ＋ スクロール停車駅）
          trainHTML += `
            <div class="jr-row" style="background: #111; border-left: 4px solid #f44;">
              <div class="jr-time" style="font-size: 30px; width: 100px;">${dn[0].time}</div>
              <div class="jr-dest" style="font-size: 30px; color: #ff9800;">${dn[0].dest}</div>
            </div>
            <div class="stops">
              <span>停車駅 ▶ ${dn[0].stops ? dn[0].stops.join(" → ") : "各駅停車"}</span>
            </div>
            <div style="height: 10px; border-bottom: 1px dashed #444; margin-bottom: 10px;"></div>
          `;
          // 2番目・3番目
          dn.slice(1,3).forEach(t=>{
            trainHTML += `
              <div class="jr-row" style="opacity: 0.8; font-size: 20px;">
                <div class="jr-time">${t.time}</div>
                <div class="jr-dest">${t.dest}</div>
              </div>
            `;
          });
        }
        trainHTML += `</div>`;
      }
    }

    /* バス表示：変更なし（前回と同じループ処理を記述） */
    if(data.bus){
      for(let k in data.bus){
        const stop = data.bus[k];
        const bd = stop[mode] || { toStation: [], toTown: [] };
        busHTML += `
          <div class="jr-board">
            <h3>（アルピコ交通） ${stop.name}</h3>
            <div class="bus-columns">
              <div class="bus-col">
                <b>▶ 駅方面</b>
                ${bd.toStation.map(t=>`<div class="jr-row"><div class="jr-time">${t}</div><div class="jr-dest">駅行き</div></div>`).join("")}
              </div>
              <div class="bus-col">
                <b>▶ 町方面</b>
                ${bd.toTown.map(t=>`<div class="jr-row"><div class="jr-time">${t}</div><div class="jr-dest">町行き</div></div>`).join("")}
              </div>
            </div>
          </div>`;
      }
    }

    document.getElementById("trainBoard").innerHTML = trainHTML;
    document.getElementById("busBoard").innerHTML = busHTML;
    setupStopScroll();
  });
}

// 4. スクロール処理（より堅牢なロジック）
function setupStopScroll() {
  document.querySelectorAll(".stops:not(.fixed) span").forEach(span => {
    let timerId = null;

    const play = () => {
      // DOMから消えていたら終了
      if (!document.body.contains(span)) return;

      const parent = span.parentElement;
      const textW = span.scrollWidth; 
      const boxW = parent.clientWidth;

      const startPos = boxW;
      const endPos = -textW - 10; // 完全に消し去るために少し余裕を持たせる

      const speed = 70; // JR風の速さ
      const duration = (startPos - endPos) / speed;

      // リセット
      span.style.transition = "none";
      span.style.transform = `translateX(${startPos}px)`;
      
      // 強制リフロー
      span.offsetHeight;

      // アニメーション設定
      span.style.transition = `transform ${duration}s linear`;
      span.style.transform = `translateX(${endPos}px)`;

      // 完全に消え去ったタイミングで5秒待機してループ
      timerId = setTimeout(() => {
        play();
      }, (duration * 1000) + 5000);
    };

    play();
  });
}

// 初回実行
loadTransport();

// 30秒ごとにチェック（データが変わった時だけ書き換わる）
setInterval(loadTransport, 10000);
</script>

</body>
</html>



